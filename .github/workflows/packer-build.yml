name: Build Custom AMI with Packer

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'packer/**'
      - 'pom.xml'
      - '.github/workflows/packer-build.yml'

env:
  PACKER_LOG: 1

permissions:
  contents: read

concurrency:
  group: packer-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    if: github.repository_owner == 'CSYE6225Assignments'

    env:
      TEST_MYSQL_ROOT_PASSWORD: ${{ secrets.TEST_MYSQL_ROOT_PASSWORD }}
      TEST_MYSQL_DATABASE: ${{ vars.TEST_MYSQL_DATABASE }}
      TEST_MYSQL_USER: ${{ vars.TEST_MYSQL_USER }}
      TEST_MYSQL_PASSWORD: ${{ secrets.TEST_MYSQL_PASSWORD }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.TEST_MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.TEST_MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.TEST_MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.TEST_MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -uroot -p$MYSQL_ROOT_PASSWORD --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install MySQL client
        run: sudo apt-get update -y && sudo apt-get install -y mysql-client

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..60}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u"$TEST_MYSQL_USER" -p"$TEST_MYSQL_PASSWORD" --silent; then
              echo " MySQL is ready!"
              exit 0
            fi
            echo "Waiting for MySQL... ($i/60)"
            sleep 2
          done
          echo " MySQL did not become ready in time"
          exit 1

      - name: Create log directory for tests
        run: |
          sudo mkdir -p /var/log/csye6225
          sudo chmod 777 /var/log/csye6225

      - name: Run integration tests
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/${{ env.TEST_MYSQL_DATABASE }}?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: ${{ env.TEST_MYSQL_USER }}
          SPRING_DATASOURCE_PASSWORD: ${{ env.TEST_MYSQL_PASSWORD }}
        run: |
          echo "Running integration tests..."
          ./mvnw -B -Duser.timezone=UTC clean verify

  build-artifact:
    name: Build Application Artifact
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.repository_owner == 'CSYE6225Assignments'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR artifact
        run: |
          echo "Building application artifact..."
          ./mvnw -B clean package -DskipTests
          
          JAR_FILE=$(find target -type f -name "*.jar" ! -name "*sources.jar" ! -name "*javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo " No JAR file found in target/"
            exit 1
          fi
          
          echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
          echo " Built JAR: $JAR_FILE"
          ls -lh "$JAR_FILE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: ${{ env.JAR_PATH }}
          if-no-files-found: error
          retention-days: 1

  build-ami:
    name: Build Custom AMI
    runs-on: ubuntu-latest
    needs: build-artifact
    if: github.repository_owner == 'CSYE6225Assignments'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download application artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: Verify artifact downloaded
        run: |
          echo "Contents of target/ after download:"
          ls -lh target/
          
          JAR_FILE=$(find target -type f -name "*.jar" ! -name "*sources.jar" ! -name "*javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo " JAR file not found after download"
            exit 1
          fi
          
          echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
          echo " Using JAR: $JAR_FILE"

      - name: Install required tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Configure AWS credentials (DEV)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Verify AWS identity (DEV)
        run: |
          echo "Verifying DEV AWS credentials..."
          aws sts get-caller-identity

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: 'latest'

      - name: Packer init
        working-directory: packer
        run: |
          echo "Initializing Packer..."
          packer init .

      - name: Packer format check
        working-directory: packer
        run: |
          echo "Checking Packer formatting..."
          packer fmt -check -recursive .
          echo " Packer files are properly formatted"

      - name: Packer validate
        working-directory: packer
        env:
          PKR_VAR_aws_region: ${{ vars.AWS_REGION }}
          PKR_VAR_subnet_id: ${{ vars.SUBNET_ID }}
          PKR_VAR_security_group_id: ${{ vars.SECURITY_GROUP_ID }}
          PKR_VAR_ami_users: '["${{ secrets.DEMO_ACCOUNT_ID }}"]'
        run: |
          echo "Validating Packer template..."
          packer validate \
            -var "app_artifact_path=../${{ env.JAR_PATH }}" \
            .
          echo " Packer template is valid"

      - name: Build AMI with Packer (DEV)
        working-directory: packer
        env:
          PKR_VAR_aws_region: ${{ vars.AWS_REGION }}
          PKR_VAR_subnet_id: ${{ vars.SUBNET_ID }}
          PKR_VAR_security_group_id: ${{ vars.SECURITY_GROUP_ID }}
          PKR_VAR_ami_users: '["${{ secrets.DEMO_ACCOUNT_ID }}"]'
        run: |
          echo "Building custom AMI in DEV account..."
          echo "This will take 5-10 minutes..."
          packer build \
            -var "app_artifact_path=../${{ env.JAR_PATH }}" \
            .

      - name: Extract AMI ID from manifest
        working-directory: packer
        run: |
          if [ ! -f manifest.json ]; then
            echo " manifest.json not found"
            exit 1
          fi
          
          AMI_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | awk -F: '{print $2}')
          
          if [ -z "$AMI_ID" ] || [ "$AMI_ID" = "null" ]; then
            echo " Could not parse AMI ID from manifest"
            cat manifest.json
            exit 1
          fi
          
          echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
          echo " Created AMI: $AMI_ID"

      - name: Verify AMI state (DEV)
        run: |
          echo "Verifying AMI was created successfully..."
          aws ec2 describe-images \
            --image-ids "${{ env.AMI_ID }}" \
            --region "${{ vars.AWS_REGION }}" \
            --query 'Images[0].[ImageId,Name,State,CreationDate]' \
            --output table

      - name: Verify AMI is shared with DEMO account
        run: |
          echo "Verifying AMI is shared with DEMO account..."
          SHARED=$(aws ec2 describe-image-attribute \
            --image-id "${{ env.AMI_ID }}" \
            --attribute launchPermission \
            --region "${{ vars.AWS_REGION }}" \
            --query "LaunchPermissions[?UserId=='${{ secrets.DEMO_ACCOUNT_ID }}'].UserId" \
            --output text)
          
          if [ "$SHARED" = "${{ secrets.DEMO_ACCOUNT_ID }}" ]; then
            echo " AMI is shared with DEMO account"
          else
            echo " AMI is NOT shared with DEMO account"
            exit 1
          fi

      # =========================================================================
      # PHASE 9 NEW STEPS: Deploy to DEMO
      # =========================================================================

      - name: Reconfigure GitHub Runner AWS CLI for DEMO account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.DEMO_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEMO_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Verify AWS identity switched to DEMO
        run: |
          echo "=== Switched to DEMO Account ==="
          aws sts get-caller-identity

      - name: Create new Launch Template version with latest AMI
        id: create-lt-version
        run: |
          echo "Creating new Launch Template version..."
          echo "Launch Template: ${{ vars.DEMO_LAUNCH_TEMPLATE_NAME }}"
          echo "AMI ID: ${{ env.AMI_ID }}"
          
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name ${{ vars.DEMO_LAUNCH_TEMPLATE_NAME }} \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"${{ env.AMI_ID }}\"}" \
            --region ${{ vars.AWS_REGION }} \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo " Created Launch Template version: $NEW_VERSION"

      - name: Set Launch Template to use latest version
        run: |
          echo "Configuring Auto Scaling Group to use latest Launch Template version..."
          
          aws ec2 modify-launch-template \
            --launch-template-name ${{ vars.DEMO_LAUNCH_TEMPLATE_NAME }} \
            --default-version '$Latest' \
            --region ${{ vars.AWS_REGION }}
          
          echo " Launch Template configured to use \$Latest"

      - name: Start instance refresh
        id: start-refresh
        run: |
          echo "Starting instance refresh for Auto Scaling Group: ${{ vars.DEMO_ASG_NAME }}"
          
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ vars.DEMO_ASG_NAME }} \
            --region ${{ vars.AWS_REGION }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300,
              "CheckpointDelay": 60,
              "CheckpointPercentages": [50, 100],
              "SkipMatching": false
            }' \
            --query 'InstanceRefreshId' \
            --output text)
          
          echo "refresh_id=$REFRESH_ID" >> $GITHUB_OUTPUT
          echo " Instance refresh started: $REFRESH_ID"

      - name: Wait for instance refresh to complete
        id: wait-refresh
        run: |
          echo "Waiting for instance refresh to complete..."
          echo "Refresh ID: ${{ steps.start-refresh.outputs.refresh_id }}"
          echo "This may take 10-15 minutes..."
          
          while true; do
            REFRESH_STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ vars.DEMO_ASG_NAME }} \
              --instance-refresh-ids ${{ steps.start-refresh.outputs.refresh_id }} \
              --region ${{ vars.AWS_REGION }} \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
          
            PERCENTAGE=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ vars.DEMO_ASG_NAME }} \
              --instance-refresh-ids ${{ steps.start-refresh.outputs.refresh_id }} \
              --region ${{ vars.AWS_REGION }} \
              --query 'InstanceRefreshes[0].PercentageComplete' \
              --output text)
          
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Status: $REFRESH_STATUS | Progress: ${PERCENTAGE}%"
          
            if [ "$REFRESH_STATUS" = "Successful" ]; then
              echo " Instance refresh completed successfully!"
              echo "refresh_status=success" >> $GITHUB_OUTPUT
              exit 0
          
            elif [ "$REFRESH_STATUS" = "Failed" ] || [ "$REFRESH_STATUS" = "Cancelled" ] || [ "$REFRESH_STATUS" = "RollbackSuccessful" ] || [ "$REFRESH_STATUS" = "RollbackFailed" ]; then
              echo " Instance refresh failed with status: $REFRESH_STATUS"
          
              STATUS_REASON=$(aws autoscaling describe-instance-refreshes \
                --auto-scaling-group-name ${{ vars.DEMO_ASG_NAME }} \
                --instance-refresh-ids ${{ steps.start-refresh.outputs.refresh_id }} \
                --region ${{ vars.AWS_REGION }} \
                --query 'InstanceRefreshes[0].StatusReason' \
                --output text)
          
              echo "Failure reason: $STATUS_REASON"
              echo "refresh_status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          
            sleep 30
          done

      - name: Verify DEMO deployment
        run: |
          echo "=== Verifying DEMO Deployment ==="
          
          # Check target health
          TG_ARN=$(aws elbv2 describe-target-groups \
            --names csye6225-demo-tg \
            --region ${{ vars.AWS_REGION }} \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text)
          
          echo "Target Group Health:"
          aws elbv2 describe-target-health \
            --target-group-arn $TG_ARN \
            --region ${{ vars.AWS_REGION }} \
            --query 'TargetHealthDescriptions[*].[Target.Id,TargetHealth.State]' \
            --output table
          
          # Test application endpoint
          echo "Testing DEMO application endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://demo.dhruvbaraiya.me/healthz)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo " DEMO application is healthy (HTTP $HTTP_CODE)"
          else
            echo " DEMO application returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ AMI Build and DEMO Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AMI Build (DEV Account)" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **AMI ID** | \`${{ env.AMI_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ vars.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Shared with DEMO** |  Account ${{ secrets.DEMO_ACCOUNT_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DEMO Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Launch Template** | \`${{ vars.DEMO_LAUNCH_TEMPLATE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **New LT Version** | \`${{ steps.create-lt-version.outputs.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ASG** | \`${{ vars.DEMO_ASG_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Refresh ID** | \`${{ steps.start-refresh.outputs.refresh_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Refresh Status** | ${{ steps.wait-refresh.outputs.refresh_status == 'success' && ' Successful' || ' Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "- Application endpoint: https://demo.dhruvbaraiya.me/healthz" >> $GITHUB_STEP_SUMMARY